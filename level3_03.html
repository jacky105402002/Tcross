<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="utf-8" />
    <title>關卡三｜環保餐具遊戲</title>
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, viewport-fit=cover"
    />
    <link rel="stylesheet" href="./css/level3.css" />
    <style>
      .stage {
        position: absolute;
        inset: 0;
      }
      .spawn {
        position: absolute;
        width: var(--slot-size, 110px);
        transform: translate(-50%, -50%);
        display: none;
        z-index: 3;
        pointer-events: none;
      }
      .spawn > img {
        width: 100%;
        height: auto;
        display: block;
        pointer-events: auto;
        -webkit-user-drag: none;
        user-select: none;
        touch-action: manipulation;
      }

      @media (min-width: 1600px) {
        .spawn {
          --slot-size: 120px;
        }
      }
      @media (max-width: 1440px) {
        .spawn {
          --slot-size: 95px;
        }
      }
      @media (max-width: 1280px) {
        .spawn {
          --slot-size: 88px;
        }
      }

      body.show-hotspots .spawn::before {
        content: "";
        position: absolute;
        inset: 0;
        border-radius: 50%;
        outline: 3px solid rgba(255, 0, 0, 0.9);
        background: rgba(255, 0, 0, 0.15);
        pointer-events: none;
      }
    </style>
  </head>
  <body>
    <div class="game-wrap bg-game">
      <div class="stage" id="stage">
        <div class="timer-badge" id="timer">90</div>
        <div class="score-pill" id="scorePill">分數：0</div>

        <div class="spawn slot-1" id="spawn-1"></div>
        <div class="spawn slot-2" id="spawn-2"></div>
        <div class="spawn slot-3" id="spawn-3"></div>
        <div class="spawn slot-4" id="spawn-4"></div>
        <div class="spawn slot-5" id="spawn-5"></div>
        <div class="spawn slot-6" id="spawn-6"></div>
      </div>
    </div>

    <div class="rotate-mask" id="rotateMask">
      <div class="rotate-box"><p>請將裝置旋轉為橫向以獲得最佳體驗</p></div>
    </div>

    <script src="./js/level3.js"></script>
    <script>
      const DEBUG_HOTSPOTS = false;
      if (DEBUG_HOTSPOTS) document.body.classList.add("show-hotspots");

      requireCookieOrBack("level3_01", "./level3_01.html");
      requireCookieOrBack("level3_02", "./level3_02.html");
      handleOrientationMask();

      /* 遊戲參數 */
      const GAME_SECONDS = 90;
      const SHOW_MS = 2000;
      const GAP_MS = 0;

      /* 權重表：每張圖自己的分數 */
      const ADD_ITEMS = [
        { src: "./image/add_1.png", score: +2 },
        { src: "./image/add_2.png", score: +2 },
        { src: "./image/add_3.png", score: +2 },
        { src: "./image/add_4.png", score: +3 },
        { src: "./image/add_5.png", score: +3 },
        { src: "./image/add_6.png", score: +3 },
      ];
      const CUT_ITEMS = [
        { src: "./image/cut_1.png", score: -1 },
        { src: "./image/cut_2.png", score: -1 },
        { src: "./image/cut_3.png", score: -1 },
        { src: "./image/cut_4.png", score: -1 },
        { src: "./image/cut_5.png", score: -1 },
        { src: "./image/cut_6.png", score: -2 },
      ];
      [...ADD_ITEMS, ...CUT_ITEMS].forEach((it) => {
        const i = new Image();
        i.src = it.src;
      });

      const spawns = [...document.querySelectorAll(".spawn")];
      const timerEl = document.getElementById("timer");
      const scorePill = document.getElementById("scorePill");

      let score = 0;
      let addSum = 0; // 環保餐具分數（加總正分）
      let cutSumNeg = 0; // 一次性餐具分數（加總負分，最後取絕對值）
      let timeLeft = GAME_SECONDS;
      let playing = true;
      let spawnTimer = null;
      let tickTimer = null;

      function refreshScore() {
        scorePill.textContent = `分數：${score}`;
      }

      function startCountdown() {
        timerEl.textContent = timeLeft;
        tickTimer = setInterval(() => {
          timeLeft -= 1;
          if (timeLeft <= 0) {
            timerEl.textContent = 0;
            gameOver();
            return;
          }
          timerEl.textContent = timeLeft;
        }, 1000);
      }

      const pick = (arr) => arr[Math.floor(Math.random() * arr.length)];

      function showOne() {
        if (!playing) return;
        spawns.forEach((s) => {
          s.style.display = "none";
          s.replaceChildren();
        });

        const target = pick(spawns);
        const isAdd = Math.random() < 0.5;
        const item = isAdd ? pick(ADD_ITEMS) : pick(CUT_ITEMS);

        const img = document.createElement("img");
        img.src = item.src;
        img.alt =
          item.score > 0 ? `加 ${item.score}` : `扣 ${Math.abs(item.score)}`;
        img.dataset.delta = String(item.score);
        img.addEventListener("pointerdown", onHit, { once: true });

        target.appendChild(img);
        target.style.display = "block";

        spawnTimer = setTimeout(() => {
          target.style.display = "none";
          target.replaceChildren();
          if (!playing) return;
          if (GAP_MS > 0) setTimeout(showOne, GAP_MS);
          else showOne();
        }, SHOW_MS);
      }

      function onHit(e) {
        if (!playing) return;
        const delta = Number(e.currentTarget.dataset.delta || 0);
        score += delta;
        if (delta > 0) addSum += delta;
        else cutSumNeg += delta; // delta 是負數，先累加，結算時取 Math.abs
        refreshScore();

        const parent = e.currentTarget.parentElement;
        if (parent) {
          parent.style.display = "none";
          parent.replaceChildren();
        }
      }

      function gameOver() {
        playing = false;
        if (spawnTimer) clearTimeout(spawnTimer);
        if (tickTimer) clearInterval(tickTimer);

        // 寫入 cookie：總分、兩邊的加總
        setCookie("level3_score", String(score), {
          path: "/",
          sameSite: "Lax",
        });
        setCookie("level3_add_sum", String(addSum), {
          path: "/",
          sameSite: "Lax",
        });
        setCookie("level3_cut_sum_abs", String(Math.abs(cutSumNeg)), {
          path: "/",
          sameSite: "Lax",
        });

        location.href = "./level3_04.html";
      }
      attachAutoFullscreen(); // 不傳 target → 綁 document
      refreshScore();
      startCountdown();
      showOne();

      document.addEventListener("fullscreenchange", () => {
        const badge = document.querySelector(".timer-badge");
        if (!document.fullscreenElement) {
          // 尚未開啟全螢幕 → 改成 10.3%
          badge.style.top = "10.3%";
        } else {
          // 已進入全螢幕 → 用原本的 16.3%
          badge.style.top = "16.3%";
        }
      });
    </script>
  </body>
</html>

<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="utf-8" />
    <title>關卡三｜環保餐具遊戲</title>
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, viewport-fit=cover"
    />
    <link rel="stylesheet" href="./css/level3.css" />
    <style>
      .stage {
        position: absolute;
        inset: 0;
      }
      .spawn {
        position: absolute;
        width: var(--slot-size, 110px);
        transform: translate(-50%, -50%);
        display: none;
        z-index: 3;
        pointer-events: none;
      }
      .spawn > img {
        width: 100%;
        height: auto;
        display: block;
        pointer-events: auto;
        -webkit-user-drag: none;
        user-select: none;
        touch-action: manipulation;
      }

      @media (min-width: 1600px) {
        .spawn {
          --slot-size: 120px;
        }
      }
      @media (max-width: 1440px) {
        .spawn {
          --slot-size: 95px;
        }
      }
      @media (max-width: 1280px) {
        .spawn {
          --slot-size: 88px;
        }
      }

      body.show-hotspots .spawn::before {
        content: "";
        position: absolute;
        inset: 0;
        border-radius: 50%;
        outline: 3px solid rgba(255, 0, 0, 0.9);
        background: rgba(255, 0, 0, 0.15);
        pointer-events: none;
      }
    </style>
  </head>
  <body>
    <div class="game-wrap bg-game">
      <div class="stage" id="stage">
        <div class="timer-badge" id="timer">90</div>
        <div class="score-pill" id="scorePill">分數：0</div>

        <div class="spawn slot-1" id="spawn-1"></div>
        <div class="spawn slot-2" id="spawn-2"></div>
        <div class="spawn slot-3" id="spawn-3"></div>
        <div class="spawn slot-4" id="spawn-4"></div>
        <div class="spawn slot-5" id="spawn-5"></div>
        <div class="spawn slot-6" id="spawn-6"></div>
      </div>
    </div>

    <div class="rotate-mask" id="rotateMask">
      <div class="rotate-box"><p>請將裝置旋轉為橫向以獲得最佳體驗</p></div>
    </div>

    <script src="./js/level3.js"></script>
    <script>
      /* ====== 音效：低延遲 + 可重疊播放 ====== */
      function makeSfxPool(url, size = 4) {
        const pool = Array.from({ length: size }, () => {
          const a = new Audio(url);
          a.preload = "auto";
          a.crossOrigin = "anonymous";
          return a;
        });
        let idx = 0;

        return {
          play() {
            const a = pool[idx];
            // 讓同一個音效可快速重播
            try {
              a.currentTime = 0;
            } catch (e) {}
            a.play().catch(() => {});
            idx = (idx + 1) % pool.length;
          },
          /** 首次手勢解鎖用：在使用者第一次點擊時，無聲播放一下再停 */
          prime() {
            const a = pool[0];
            const oldVol = a.volume;
            a.volume = 0;
            a.play()
              .then(() => {
                a.pause();
                a.currentTime = 0;
                a.volume = oldVol;
              })
              .catch(() => {
                // 有些瀏覽器就算在手勢中也可能丟錯，忽略即可
              });
          },
        };
      }

      // 建兩個池：成功音/失敗音
      const SFX = {
        success: makeSfxPool("./image/success.wav", 6),
        error: makeSfxPool("./image/error.wav", 6),
      };

      // 一次性手勢解鎖（iOS/Safari 等需要）
      function unlockAudioOnce() {
        SFX.success.prime();
        SFX.error.prime();
        window.removeEventListener("pointerdown", unlockAudioOnce);
        window.removeEventListener("touchstart", unlockAudioOnce);
        window.removeEventListener("click", unlockAudioOnce);
      }
      window.addEventListener("pointerdown", unlockAudioOnce, { once: true });
      window.addEventListener("touchstart", unlockAudioOnce, { once: true });
      window.addEventListener("click", unlockAudioOnce, { once: true });

      const DEBUG_HOTSPOTS = false;
      if (DEBUG_HOTSPOTS) document.body.classList.add("show-hotspots");

      requireCookieOrBack("level3_01", "./level3_01.html");
      requireCookieOrBack("level3_02", "./level3_02.html");
      handleOrientationMask();

      /* 遊戲參數 */
      const GAME_SECONDS = 90;
      const SHOW_MS = 2000;
      const GAP_MS = 0;

      /* 權重表：每張圖自己的分數 */
      const ADD_ITEMS = [
        { src: "./image/add_1.png", score: +2 },
        { src: "./image/add_2.png", score: +2 },
        { src: "./image/add_3.png", score: +2 },
        { src: "./image/add_4.png", score: +3 },
        { src: "./image/add_5.png", score: +3 },
        { src: "./image/add_6.png", score: +3 },
      ];
      const CUT_ITEMS = [
        { src: "./image/cut_1.png", score: -1 },
        { src: "./image/cut_2.png", score: -1 },
        { src: "./image/cut_3.png", score: -1 },
        { src: "./image/cut_4.png", score: -1 },
        { src: "./image/cut_5.png", score: -1 },
        { src: "./image/cut_6.png", score: -2 },
      ];
      [...ADD_ITEMS, ...CUT_ITEMS].forEach((it) => {
        const i = new Image();
        i.src = it.src;
      });

      const spawns = [...document.querySelectorAll(".spawn")];
      const timerEl = document.getElementById("timer");
      const scorePill = document.getElementById("scorePill");

      let score = 0;
      let addSum = 0; // 環保餐具分數（加總正分）
      let cutSumNeg = 0; // 一次性餐具分數（加總負分，最後取絕對值）
      let timeLeft = GAME_SECONDS;
      let playing = true;
      let spawnTimer = null;
      let tickTimer = null;

      function refreshScore() {
        scorePill.textContent = `分數：${score}`;
      }

      function startCountdown() {
        timerEl.textContent = timeLeft;
        tickTimer = setInterval(() => {
          timeLeft -= 1;
          if (timeLeft <= 0) {
            timerEl.textContent = 0;
            gameOver();
            return;
          }
          timerEl.textContent = timeLeft;
        }, 1000);
      }

      const pick = (arr) => arr[Math.floor(Math.random() * arr.length)];

      function showOne() {
        if (!playing) return;
        spawns.forEach((s) => {
          s.style.display = "none";
          s.replaceChildren();
        });

        const target = pick(spawns);
        const isAdd = Math.random() < 0.5;
        const item = isAdd ? pick(ADD_ITEMS) : pick(CUT_ITEMS);

        const img = document.createElement("img");
        img.src = item.src;
        img.alt =
          item.score > 0 ? `加 ${item.score}` : `扣 ${Math.abs(item.score)}`;
        img.dataset.delta = String(item.score);
        img.addEventListener("pointerdown", onHit, { once: true });

        target.appendChild(img);
        target.style.display = "block";

        spawnTimer = setTimeout(() => {
          target.style.display = "none";
          target.replaceChildren();
          if (!playing) return;
          if (GAP_MS > 0) setTimeout(showOne, GAP_MS);
          else showOne();
        }, SHOW_MS);
      }

      function onHit(e) {
        if (!playing) return;
        const delta = Number(e.currentTarget.dataset.delta || 0);
        score += delta;
        if (delta > 0) {
          addSum += delta;
          SFX.success.play(); // ← 加分播成功音
        } else {
          cutSumNeg += delta; // delta 為負
          SFX.error.play(); // ← 扣分播失敗音
        }
        refreshScore();

        const parent = e.currentTarget.parentElement;
        if (parent) {
          parent.style.display = "none";
          parent.replaceChildren();
        }
      }

      function gameOver() {
        playing = false;
        if (spawnTimer) clearTimeout(spawnTimer);
        if (tickTimer) clearInterval(tickTimer);

        // 寫入 cookie：總分、兩邊的加總
        setCookie("level3_score", String(score), {
          path: "/",
          sameSite: "Lax",
        });
        setCookie("level3_add_sum", String(addSum), {
          path: "/",
          sameSite: "Lax",
        });
        setCookie("level3_cut_sum_abs", String(Math.abs(cutSumNeg)), {
          path: "/",
          sameSite: "Lax",
        });

        location.href = "./level3_04.html";
      }
      attachAutoFullscreen(); // 不傳 target → 綁 document

      // 依全螢幕狀態更新計時徽章位置
      function updateTimerBadgeTop() {
        const badge = document.querySelector(".timer-badge");
        if (!badge) return;
        const isFS = !!(
          document.fullscreenElement ||
          document.webkitFullscreenElement ||
          document.msFullscreenElement
        );
        // 若你的 CSS 有 !important，可改用這行：
        // badge.style.setProperty('top', isFS ? '16.3%' : '10.3%', 'important');
        badge.style.top = isFS ? "16.3%" : "10.3%";
      }

      // 先掛事件
      document.addEventListener("fullscreenchange", updateTimerBadgeTop);
      document.addEventListener("webkitfullscreenchange", updateTimerBadgeTop); // Safari
      document.addEventListener("msfullscreenchange", updateTimerBadgeTop); // 舊 Edge

      // **關鍵：進頁面就先判斷一次**
      // 確保 DOM 有了再跑，三重保險：立即、DOMContentLoaded、下一幀
      updateTimerBadgeTop();
      document.addEventListener("DOMContentLoaded", updateTimerBadgeTop, {
        once: true,
      });
      requestAnimationFrame(updateTimerBadgeTop);

      refreshScore();
      startCountdown();
      showOne();
    </script>
  </body>
</html>
